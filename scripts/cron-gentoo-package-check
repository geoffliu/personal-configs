#!/bin/bash

PackageFile=$($HOME/bin/get-status-file packages)
PackageFileTime=$(stat -c %Y $PackageFile)
EmergeLogTime=$(stat -c %Y /var/log/emerge.log)
PortageTime=$(date -d "$(cat /var/db/repos/gentoo/metadata/timestamp.chk)" +%s)
NowTime=$(date +%s)

ConfigFilesToSync=(
  /etc/genkernel.conf
  /etc/kernels/kernel-config-$(uname -r)
  /etc/portage/make.conf
  /etc/portage/package.use
  /etc/portage/profile/package.provided
  /var/lib/portage/world
)

for f in ${ConfigFilesToSync[@]}; do
  LocalFile=$PERSONAL_CONFIG_DIR/linux/gentoo/$(basename $f)
  LocalFileTime=$(stat -c %Y $LocalFile || echo 0)
  LiveConfigTime=$(stat -c %Y $f)
  if (($LiveConfigTime > $LocalFileTime)); then
    cp $f $LocalFile
  fi
done

ChangedFiles=$(git -C $PERSONAL_CONFIG_DIR status -s | grep linux/gentoo | wc -l)
if (($ChangedFiles != 0)); then
  echo "ðŸ“¦ðŸ“" > $PackageFile
  exit
fi

if (($NowTime - $PortageTime > 3600 * 24)); then
  echo "ðŸ“¦ðŸ”„" > $PackageFile
  exit
fi

function check_emerge_update {
  UpdateCount=$(emerge --pretend --quiet --update --deep @world | wc -l)
  if (($UpdateCount >= 5)); then
    echo "ðŸ“¦ $UpdateCount" > $PackageFile
    exit
  fi
}

if (($PortageTime > $EmergeLogTime && $PackageFileTime - $PortageTime < 300)); then
  check_emerge_update
fi

if (($EmergeLogTime > $PackageFileTime)); then
  check_emerge_update
fi

echo "ðŸ“¦âœ…" > $PackageFile
