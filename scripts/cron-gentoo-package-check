#!/bin/bash

PackageFile=$HOME/.ownconfigs/linux/status_files/packages
PackageFileTime=$(stat -c %Y $PackageFile || echo 0)
EmergeLogTime=$(stat -c %Y /var/log/emerge.log)
PortageTime=$(date -d "$(cat /var/db/repos/gentoo/metadata/timestamp.chk)" +%s)
NowTime=$(date +%s)

if (($NowTime - $PortageTime > 3600 * 24)); then
  if (($NowTime - $PackageFileTime > 3600)); then
    echo "ðŸ“¦ðŸ”„" > ~/.ownconfigs/linux/status_files/packages
  fi
  exit
fi

function check_emerge_update {
  UpdateCount=$(emerge --pretend --quiet --update --deep @world | wc -l)
  if (($UpdateCount >= 5)); then
    echo "ðŸ“¦ $UpdateCount" > $PackageFile
  else
    echo "ðŸ“¦âœ…" > $PackageFile
  fi
}

if (($PortageTime > $EmergeLogTime && $PackageFileTime - $PortageTime < 600)); then
  check_emerge_update
  exit
fi

if (($EmergeLogTime > $PackageFileTime)); then
  check_emerge_update
  exit
fi

if (($NowTime - $PackageFileTime < 3600)); then
  exit
fi

ConfigFilesToSync=(
  /etc/genkernel.conf
  /etc/kernels/kernel-config-$(uname -r)
  /etc/portage/make.conf
  /etc/portage/package.use
  /etc/portage/profile/package.provided
  /var/lib/portage/world
)

OutOfSync=0
for f in ${ConfigFilesToSync[@]}; do
  LocalFile=$HOME/.ownconfigs/linux/gentoo/$(basename $f)
  diff $f $LocalFile >> /dev/null
  if (($? != 0)); then
    cp $f $LocalFile
    OutOfSync=1
  fi
done

if (($OutOfSync == 1)); then
  echo "ðŸ“¦ðŸ“" > $PackageFile
fi

