#!/bin/bash

PackageFile=$($HOME/bin/get-status-file packages)
PackageFileTime=$(stat -c %Y $PackageFile)
PacmanTime=$(stat -c %Y /var/log/pacman.log)
NowTime=$(date +%s)

if (($PacmanTime < $PackageFileTime && $NowTime - $PackageFileTime < 21600)); then
  exit
fi

TmpFile=$(mktemp --tmpdir package-check-XXXXX)
ResultString=""

checkupdates > "$TmpFile"
if (( $? != 0 && $? != 2)); then
  echo Error running check updates
  cat "$TmpFile"
  echo "ï‘¦ ðŸ”´" > $PackageFile
  exit
fi

yay -Qua >> "$TmpFile"
if (( $? != 0 )); then
  echo Error running yay
  cat "$TmpFile"
  echo "ï‘¦ ðŸ”´" > $PackageFile
  exit
fi

UpdateCount=$(<"$TmpFile" wc -l)

if (($UpdateCount >= 10)); then
  ResultString="ï‘¦ $UpdateCount"
else
  ResultString=""
fi

echo $ResultString > $PackageFile
date
echo Update result: $UpdateCount available

rm $TmpFile

